name: Sync VAir & Build

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

env:
  JAVA_VERSION: 17
  TARGET_BRANCH: "main"
  UPSTREAM_URL: "https://github.com/GigaBrawler/Valkyrien-Air.git"
  MOD_PREFIX: "valkyrien-air"
  R2_BUCKET: ${{ secrets.R2_BUCKET_NAME }}
  R2_ACCOUNT_ID: ${{ secrets.R2_ACCOUNT_ID }}
  R2_ACCESS_KEY: ${{ secrets.R2_ACCESS_KEY_ID }}
  R2_SECRET_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}

jobs:
  sync-and-build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          ref: ${{ env.TARGET_BRANCH }}
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git remote add upstream ${{ env.UPSTREAM_URL }}
          git fetch upstream

      - name: Check Upstream Changes (Last 24h)
        id: check_update
        run: |
          UPSTREAM_TIME=$(git log -1 --format=%ct upstream/${{ env.TARGET_BRANCH }})
          DAY_AGO=$(date -d "24 hours ago" +%s)
          if [ "$UPSTREAM_TIME" -gt "$DAY_AGO" ]; then
            echo "has_update=true" >> $GITHUB_OUTPUT
          else
            echo "has_update=false" >> $GITHUB_OUTPUT
          fi

      - name: Sync with Upstream (Merge)
        if: steps.check_update.outputs.has_update == 'true'
        run: |
          git merge upstream/${{ env.TARGET_BRANCH }} -m "chore: sync with upstream"

      - name: Setup Java
        if: steps.check_update.outputs.has_update == 'true'
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'

      - name: Build Mod (No Cache)
        if: steps.check_update.outputs.has_update == 'true'
        run: |
          chmod +x gradlew
          ./gradlew clean build --no-build-cache --no-daemon

      - name: Install Rclone
        if: steps.check_update.outputs.has_update == 'true'
        run: |
          curl -O https://downloads.rclone.org/rclone-current-linux-amd64.zip
          unzip -q rclone-current-linux-amd64.zip
          mv rclone-*-linux-amd64/rclone .
          chmod +x rclone
          echo "âœ… Rclone installed."

      - name: Process and Upload (Overwrite Old)
        if: steps.check_update.outputs.has_update == 'true'
        env:
          R2_ACCOUNT_ID: ${{ secrets.R2_ACCOUNT_ID }}
          R2_ACCESS_KEY: ${{ secrets.R2_ACCESS_KEY_ID }}
          R2_SECRET_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
          R2_BUCKET: ${{ secrets.R2_BUCKET_NAME }}
          MOD_PREFIX: ${{ env.MOD_PREFIX }}
        run: |
          # 1. åˆ›å»º Rclone é…ç½®
          mkdir -p ~/.config/rclone
          CONF_FILE="$HOME/.config/rclone/rclone.conf"
          
          echo "[myr2]" > "$CONF_FILE"
          echo "type = s3" >> "$CONF_FILE"
          echo "provider = Cloudflare" >> "$CONF_FILE"
          echo "endpoint = https://${R2_ACCOUNT_ID}.r2.cloudflarestorage.com" >> "$CONF_FILE"
          echo "access_key_id = ${R2_ACCESS_KEY}" >> "$CONF_FILE"
          echo "secret_access_key = ${R2_SECRET_KEY}" >> "$CONF_FILE"
          echo "region = auto" >> "$CONF_FILE"

          echo "âœ… Rclone config created."

          # 2. å®šä¹‰å¤„ç†å‡½æ•°ï¼šå…ˆé‡å‘½åï¼Œå†ä¸Šä¼ 
          process_and_upload() {
            local src_path="$1"
            local loader="$2"
            local original_filename=$(basename "$src_path")
            
            # è¿‡æ»¤ä¸éœ€è¦çš„æ–‡ä»¶
            if [[ "$original_filename" == *"-dev-shadow"* ]] || [[ "$original_filename" == *"-sources"* ]]; then
              echo "â­ï¸ Skip: $original_filename"
              return
            fi

            # å®šä¹‰ç›®æ ‡æ–‡ä»¶å
            local target_filename="${MOD_PREFIX}-${loader}.jar"
            
            # åˆ›å»ºä¸€ä¸ªä¸´æ—¶ç›®å½•ç”¨äºå­˜æ”¾é‡å‘½ååçš„æ–‡ä»¶ï¼Œé¿å…æ±¡æŸ“æºç æ ‘
            local upload_dir="upload_temp"
            mkdir -p "$upload_dir"
            local renamed_path="${upload_dir}/${target_filename}"

            # ã€å…³é”®æ­¥éª¤ 1ã€‘æœ¬åœ°é‡å‘½å
            cp "$src_path" "$renamed_path"
            echo "ğŸ“ Renamed: $original_filename -> $target_filename"

            # ã€å…³é”®æ­¥éª¤ 2ã€‘ä¸Šä¼ åˆ°æ¡¶çš„æ ¹ç›®å½• (æˆ–è€…æŒ‡å®šå­ç›®å½•ï¼Œä½†å¿…é¡»ä»¥ / ç»“å°¾)
            # æ ¼å¼ï¼šrclone copy ./local_file.jar remote:bucket_name/
            # æ³¨æ„ï¼šç›®æ ‡è·¯å¾„ä»¥ / ç»“å°¾ï¼Œæ˜ç¡®å‘Šè¯‰ rclone è¿™æ˜¯ä¸€ä¸ªç›®å½•ï¼Œæ–‡ä»¶åå°†å–è‡ªæœ¬åœ°æ–‡ä»¶
            local remote_dest="myr2:${R2_BUCKET}/"

            echo "â¬†ï¸ Uploading $target_filename to $remote_dest"
            
            if ./rclone copy "$renamed_path" "$remote_dest" --config "$CONF_FILE" --ignore-checksum --verbose; then
              echo "âœ… Success: $target_filename uploaded."
            else
              echo "âŒ Failed to upload $target_filename"
              exit 1
            fi
            
            # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
            rm -rf "$upload_dir"
          }

          # 3. æ‰§è¡Œé€»è¾‘

          if [ -d "build/libs" ]; then
            for f in build/libs/*.jar; do
              [ -e "$f" ] || continue
              
              loader=""
              if [[ "$f" == *"-forge.jar" ]]; then loader="forge"; fi
              if [[ "$f" == *"-fabric.jar" ]]; then loader="fabric"; fi
              
              if [ -n "$loader" ]; then
                process_and_upload "$f" "$loader"
              else
                echo "âš ï¸ Skip unknown loader: $f"
              fi
            done
          fi

          echo "ğŸ‰ All uploads processed."
